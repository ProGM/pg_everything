<!doctype html>
<html lang="en" class="wa-theme-default wa-palette-default wa-brand-blue">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sandbox</title>

    <!-- Web Awesome styles -->
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/styles/themes/default.css" />
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/styles/native.css" />

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Tailwind CSS (for custom styles) -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Web Awesome components -->
    <script type="module">
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/input/input.js';
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/select/select.js';
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/option/option.js';
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/button/button.js';
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/card/card.js';
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/dialog/dialog.js';
        import 'https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/components/icon/icon.js';
    </script>

    <style>
        .middle {
            display: grid;
            place-items: center;
            min-height: 80vh;
        }

        .login-card {
            width: min(420px, 100%);
        }
    </style>
</head>

<body x-data="app()" x-init="boot()" @keydown.window.ctrl.slash.prevent="$refs.search?.focus()">

    <!-- ========== LOGIN VIEW ========== -->
    <div class="middle" x-show="!auth.authed" x-cloak>
        <wa-card class="login-card">
            <div style="padding:1.25rem">
                <h2 style="margin:.25rem 0 1rem">Sign in</h2>

                <div class="alert-danger" x-show="auth.error">
                    <wa-icon name="circle-exclamation"></wa-icon>
                    <span x-text="auth.error"></span>
                </div>

                <wa-input placeholder="Email" type="email" autocomplete="username" @change="auth.email=$event.target.value"
                    @keydown.enter.prevent="$refs.pwd?.focus()">
                    <wa-icon name="envelope" slot="prefix"></wa-icon>
                </wa-input>

                <div style="height:.6rem"></div>

                <wa-input x-ref="pwd" placeholder="Password" type="password" autocomplete="current-password"
                    @change="auth.password=$event.target.value" @keydown.enter.prevent="auth.login()">
                    <wa-icon name="key" slot="prefix"></wa-icon>
                </wa-input>

                <div style="height:1rem"></div>

                <wa-button type="button" variant="brand" :disabled="auth.loggingIn" @click.prevent="auth.login()">
                    <wa-icon name="right-to-bracket" style="margin-right:.35rem"></wa-icon>
                    Sign in
                </wa-button>
            </div>
        </wa-card>
    </div>

    <!-- ========== APP VIEW (only after auth) ========== -->
    <div class="middle" x-show="auth.authed" x-cloak>
        <wa-card class="login-card">
            <div style="padding:1.25rem">
                <h2 style="margin:.25rem 0 1rem">Welcome!</h2>
                <p>You are now logged in.</p>

                <wa-button type="button" variant="brand" style="margin-top:1rem" @click.prevent="loadData()">
                    <wa-icon name="database" style="margin-right:.35rem"></wa-icon>
                    Load Data
                </wa-button>

                <wa-button type="button" variant="brand" style="margin-top:1rem" @click.prevent="auth.logout()">
                    <wa-icon name="right-from-bracket" style="margin-right:.35rem"></wa-icon>
                    Sign out
                </wa-button>
            </div>
        </wa-card>
    </div>

    <script src="auth.js"></script>
    <script>
        function app() {
            return {
                auth: {
                    email: '',
                    password: '',
                    error: null,
                    loggingIn: false,
                    authed: false,
                    token: null,
                    expiresAt: null,
                    login() {
                        auth.login(this.email, this.password).then((data) => {
                            this.authed = true;
                            this.token = data.token;
                            this.expiresAt = data.expiresAt;
                            this.error = null;
                        }).catch(err => {
                            this.error = err.message;
                        }).finally(() => {
                            this.loggingIn = false;
                        });
                    },
                    logout() {
                        this.authed = false;
                        this.token = null;
                        this.expiresAt = null;
                    },
                    isLoggedIn() {
                        return this.authed && this.token && (new Date(this.expiresAt) > Date.now());
                    }
                },

                apollo: null,
                client: null,
                isReady: false,
                async boot() {
                    this.apollo = await import('https://cdn.jsdelivr.net/npm/@apollo/client@4.0.8/+esm');

                    this.client = new this.apollo.ApolloClient({
                        link: new this.apollo.HttpLink({
                            uri: 'http://localhost:8080/graphql',
                        }),
                        cache: new this.apollo.InMemoryCache()
                    });
                    this.isReady = true;
                },

                loadData() {
                    this.listPokemon(1, 0).then(result => {
                        console.log('First Pokémon:', result);
                        alert('The first Pokémon is ' + result.edges[0].node.name);
                    });
                },

                async listPokemon(first, offset) {
                    const { data } = await this.client.query({
                        query: this.apollo.gql`
                            query ListPokemon($first: Int, $offset: Int) {
                                pokemonCollection(first: $first, offset: $offset, orderBy: [{id: AscNullsLast}]) {
                                    edges {
                                        node {
                                            id name description type1 type2 total generation legendary imageUrl
                                        }
                                        cursor
                                    }
                                    totalCount
                                }
                            }
                        `,
                        variables: { first, offset },
                        context: {
                            headers: {
                                authorization: this.auth.token
                            }
                        }
                    });
                    return data.pokemonCollection;
                }
            }
        }
    </script>
</body>
</html>